#!/usr/bin/env node
function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function _interopNamespace(e){if(e&&e.__esModule)return e;var r={};return e&&Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}),r.default=e,r}var fs=_interopDefault(require("fs")),readline=_interopDefault(require("readline")),path=_interopDefault(require("path"));function exitFail(e){console.log(e),process.exit(1)}function exitPass(){process.exit(0)}function readFile(e){return new Promise((r,t)=>{fs.readFile(e,"utf8",(e,n)=>{e?t(e):r(n)})})}function readJSON(e,...r){return readFile(e).then(e=>JSON.parse(e)).then(e=>r.length?e[Object.keys(e).find(e=>r.includes(e))]:e).catch(()=>({}))}function readOrWriteFile(e,r){return readFile(e).catch(()=>writeFile(e,r||"").then(()=>""))}function safelyReadFile(e){return readFile(e).catch(()=>"")}function writeFile(e,r){return new Promise((t,n)=>{fs.writeFile(e,r,e=>{e?n(e):t()})})}const colors={reset:"[0m",bold:"[1m",dim:"[2m",underline:"[4m",blink:"[5m",reverse:"[7m",hidden:"[8m",black:"[30m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",bgBlack:"[40m",bgRed:"[41m",bgGreen:"[42m",bgYellow:"[43m",bgBlue:"[44m",bgMagenta:"[45m",bgCyan:"[46m",bgWhite:"[47m"};function color(e,r){return colors[e]+r.replace(colors.reset,colors.reset+colors[e])+colors.reset}const isWin32="win32"===process.platform,tick=isWin32?"√":"✔",cross=isWin32?"×":"✖",stdout=process.stdout;let interval;function pass(e,r,t){clearInterval(interval),t?stdout.write(` ${color("green",tick)}\n`):(readline.clearLine(stdout,0),readline.cursorTo(stdout,0),stdout.write(`${color("green",tick)} ${e} ${color("dim",r)}\n`))}function fail(e,r,t,n){clearInterval(interval),n?stdout.write(` ${color("red",cross)}\n${t}\n`):(readline.clearLine(stdout,0),readline.cursorTo(stdout,0),stdout.write(`${color("red",cross)} ${e} ${color("dim",r)}\n${t}\n`))}function wait(e,r,t){if(t)stdout.write(`${e} ${color("dim",r)}`);else{const t=isWin32?"-–—–-":"⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏";let n=0;clearInterval(interval),readline.clearLine(stdout,0),readline.cursorTo(stdout,0),stdout.write(`${color("yellow",t[n])} ${e} ${color("dim",r)}`),interval=setInterval(()=>{n=(n+1)%t.length,readline.cursorTo(stdout,0),stdout.write(`${color("yellow",t[n])} ${e} ${color("dim",r)}`)},60)}}function getErrorMessage(e){return Object(e).message||e}const argRegExp=/^--([\w-]+)$/,primativeRegExp=/^(false|null|true|undefined|(\d+\.)?\d+|\{.*\}|\[.*\])$/,relaxedJsonPropRegExp=/(['"])?([a-z0-9A-Z_]+)\1:/g,relaxedJsonValueRegExp=/("[a-z0-9A-Z_]+":\s*)(?!true|false|null|\d+)'?([A-z0-9]+)'?([,}])/g;function getOptionsFromArguments(e){return process.argv.slice(2).reduce((e,r,t,n)=>{const i=n[t+1],s=r.match(argRegExp);if(s){const[,r]=s;!i||argRegExp.test(i)?e[r]=!0:e[r]=primativeRegExp.test(i)?JSON.parse(i.replace(relaxedJsonPropRegExp,'"$2": ').replace(relaxedJsonValueRegExp,'$1"$2"$3')):i}return e},Object.assign({},e))}async function getOptions(){const e=process.cwd(),r={plugin:e,config:e,fixtures:path.resolve(e,"test")},t=await readJSON("package.json","postcss","postcssConfig").then(e=>getOptionsFromArguments(Object.assign(r,e))),n=path.resolve(t.plugin),i=await new Promise(function(e){e(_interopNamespace(require(n)))});t.plugin=i;try{const e=path.extname(t.config)?path.resolve(t.config):path.resolve(t.config,"postcss-tape.config.js"),r=await new Promise(function(r){r(_interopNamespace(require(e)))});t.config=r.default||r}catch(e){const r=path.resolve(t.config,".tape.js"),n=await new Promise(function(e){e(_interopNamespace(require(r)))});t.config=n.default||n}return t}getOptions().then(async e=>{let r=!1;for(const t in e.config){const n=e.config[t],i="function"==typeof Object(n.plugin).process?n.plugin:"function"==typeof n.plugin?{process:n.plugin}:e.plugin,s=t.split(":")[0],o=t.split(":").join("."),a=path.resolve(e.fixtures,n.source||`${s}.css`),c=path.resolve(e.fixtures,n.expect||`${o}.expect.css`),l=path.resolve(e.fixtures,n.result||`${o}.result.css`),u=Object.assign({from:a,to:l},n.processOptions),g=n.options,f=Object(i.postcss).postcssPlugin||"postcss";wait(f,n.message,e.ci);try{Object(n.before)instanceof Function&&await n.before();const t=await safelyReadFile(c),s=await readOrWriteFile(a,t),o=await i.process(s,u,g),p=o.css;if(e.fix)await writeFile(c,p),await writeFile(l,p);else if(await writeFile(l,p),t!==p)throw new Error([`Expected: ${JSON.stringify(t).slice(1,-1)}`,`Received: ${JSON.stringify(p).slice(1,-1)}`].join("\n"));const d=o.warnings();if("number"==typeof n.warnings){if(n.warnings!==d.length){const e=1!==d.length?"s":"";throw new Error(`Expected: ${n.warnings} warning${e}\nReceived: ${d.length} warnings`)}}else if(d.length){if(!d.every(e=>n.warnings===Object(n.warnings)&&Object.keys(n.warnings).every(r=>n.warnings[r]instanceof RegExp?n.warnings[r].test(e[r]):n.warnings[r]===e[r]))){const e=1!==d.length?"s":"";throw new Error(`Unexpected warning${e}:\n${d.join("\n")}`)}}else{if(n.warnings)throw new Error("Expected a warning");if(n.errors)throw new Error("Expected an error")}Object(n.after)instanceof Function&&await n.after(),pass(f,n.message,e.ci)}catch(t){if("error"in n){if(n.error===Object(n.error)){if(Object.keys(n.error).every(e=>n.error[e]instanceof RegExp?n.error[e].test(Object(t)[e]):n.error[e]===Object(t)[e]))pass(f,n.message,e.ci);else{const i=Object.keys(n.error).reduce((e,r)=>Object.assign(e,{[r]:Object(t)[r]}),{});r=t,fail(f,n.message,`  Expected Error: ${JSON.stringify(n.error)}\n  Received Error: ${JSON.stringify(i)}`,e.ci)}}else{if("boolean"==typeof n.error&&n.error?pass(f,n.message,e.ci):(r=t,fail(f,n.message,"  Expected Error",e.ci)),e.ci)break}}else r=t,fail(f,n.message,getErrorMessage(t),e.ci)}}if(r)throw r}).then(exitPass,exitFail);
//# sourceMappingURL=index.js.map
